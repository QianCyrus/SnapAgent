name: Release

on:
  push:
    branches: [release]
    tags: ["v*"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: pytest tests/ --ignore=tests/test_matrix_channel.py -q

  docker:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve image tags
        id: tags
        env:
          IMAGE: ghcr.io/${{ github.repository_owner }}/snapagent
        run: |
          set -euo pipefail
          short_sha="${GITHUB_SHA::7}"

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            version_tag="${GITHUB_REF#refs/tags/}"
            {
              echo "tags<<EOF"
              echo "${IMAGE}:${version_tag}"
              echo "${IMAGE}:stable"
              echo "${IMAGE}:latest"
              echo "EOF"
            } >> "${GITHUB_OUTPUT}"
          else
            {
              echo "tags<<EOF"
              echo "${IMAGE}:canary-${short_sha}"
              echo "${IMAGE}:sha-${short_sha}"
              echo "${IMAGE}:canary"
              echo "EOF"
            } >> "${GITHUB_OUTPUT}"
          fi

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.tags.outputs.tags }}

  pypi:
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate tag matches pyproject version
        run: |
          set -euo pipefail
          tag="${GITHUB_REF#refs/tags/v}"
          version="$(python - <<'PY'
          import pathlib
          import tomllib

          data = tomllib.loads(pathlib.Path("pyproject.toml").read_text(encoding="utf-8"))
          print(data["project"]["version"])
          PY
          )"

          if [[ "${version}" != "${tag}" ]]; then
            echo "Tag version (${tag}) does not match pyproject version (${version})"
            exit 1
          fi

      - name: Build package
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine
          python -m build

      - name: Publish to PyPI
        if: ${{ secrets.PYPI_API_TOKEN != '' }}
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: python -m twine upload dist/*

      - name: Skip publish (no token configured)
        if: ${{ secrets.PYPI_API_TOKEN == '' }}
        run: echo "PYPI_API_TOKEN is not configured; skipping package upload."
