name: Release

on:
  push:
    branches: [release]
    tags: ["v*"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: pytest tests/ --ignore=tests/test_matrix_channel.py -q

  guard_tag:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tag commit belongs to release branch history
        run: |
          set -euo pipefail
          git fetch origin release --depth=1
          if ! git merge-base --is-ancestor "${GITHUB_SHA}" "origin/release"; then
            echo "Tag commit ${GITHUB_SHA} is not on release branch history."
            exit 1
          fi

  pypi:
    runs-on: ubuntu-latest
    needs: [test, guard_tag]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure PYPI_API_TOKEN exists
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${PYPI_API_TOKEN}" ]]; then
            echo "PYPI_API_TOKEN is required for version tag releases."
            exit 1
          fi

      - name: Validate tag matches pyproject version
        run: |
          set -euo pipefail
          tag="${GITHUB_REF#refs/tags/v}"
          version="$(python - <<'PY'
          import pathlib
          import tomllib

          data = tomllib.loads(pathlib.Path("pyproject.toml").read_text(encoding="utf-8"))
          print(data["project"]["version"])
          PY
          )"

          if [[ "${version}" != "${tag}" ]]; then
            echo "Tag version (${tag}) does not match pyproject version (${version})"
            exit 1
          fi

      - name: Build package
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine
          python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: python -m twine upload --skip-existing dist/*

  docker_canary:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/release'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve canary image tags
        id: tags
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY_OWNER,,}"
          image="ghcr.io/${owner}/snapagent"
          short_sha="${GITHUB_SHA::7}"
          {
            echo "tags<<EOF"
            echo "${image}:canary-${short_sha}"
            echo "${image}:sha-${short_sha}"
            echo "${image}:canary"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Build and push canary image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.tags.outputs.tags }}

  docker_stable:
    runs-on: ubuntu-latest
    needs: [test, guard_tag, pypi]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve stable image tags
        id: tags
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY_OWNER,,}"
          image="ghcr.io/${owner}/snapagent"
          version_tag="${GITHUB_REF#refs/tags/}"
          {
            echo "tags<<EOF"
            echo "${image}:${version_tag}"
            echo "${image}:stable"
            echo "${image}:latest"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Build and push stable image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.tags.outputs.tags }}
